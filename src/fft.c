/******************************************************************************
 * This file is a part of the Sysytem Microprocessor Project                  *
 ******************************************************************************/

/**
 * @file   fft.c
 * @author Maj & Zimnol
 * @date   Dec 2021
 * @brief  File containing definitions for FFT and spectrum analyzer.
 * @ver    0.1
 */

#include "fft.h"
#include "lcd1602.h"

/******************************************************************************
 * Global variable definitions
 ******************************************************************************/

float16_t FFT_Buffer[2][FFT_SIZE];
float16_t FFT_Output[2*FFT_SIZE];
uint8_t FrequencyBins[16];
FFT_Flags FFTstatus;
uint8_t oldBins[16] = {0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0};

/* Hann Window samples generated using MATLAB, can be used to apply window 
   function on collected samples */
const float16_t Hann_Window[FFT_SIZE] = {0, 0.0002, 0.0006, 0.0014, 0.0024, 0.0038, 0.0055, 0.0074, 0.0097, 0.0122, 0.0151, 0.0183, 
    0.0217, 0.0254, 0.0295, 0.0338, 0.0384, 0.0432, 0.0484, 0.0538, 0.0595, 0.0655, 0.0717, 0.0782, 0.0849, 0.0919, 0.0991, 
    0.1066, 0.1144, 0.1223, 0.1305, 0.1389, 0.1475, 0.1564, 0.1654, 0.1747, 0.1841, 0.1938, 0.2036, 0.2136, 0.2238, 0.2342, 
    0.2447, 0.2554, 0.2662, 0.2771, 0.2882, 0.2994, 0.3108, 0.3223, 0.3338, 0.3455, 0.3573, 0.3691, 0.3810, 0.3930, 0.4051, 
    0.4172, 0.4294, 0.4416, 0.4539, 0.4661, 0.4784, 0.4908, 0.5031, 0.5154, 0.5277, 0.5400, 0.5523, 0.5645, 0.5767, 0.5888, 
    0.6009, 0.6130, 0.6249, 0.6368, 0.6486, 0.6604, 0.6720, 0.6835, 0.6949, 0.7062, 0.7173, 0.7284, 0.7393, 0.7500, 0.7606, 
    0.7710, 0.7813, 0.7914, 0.8013, 0.8111, 0.8206, 0.8300, 0.8391, 0.8481, 0.8568, 0.8653, 0.8736, 0.8817, 0.8895, 0.8971, 
    0.9045, 0.9116, 0.9185, 0.9251, 0.9315, 0.9376, 0.9434, 0.9489, 0.9542, 0.9592, 0.9640, 0.9684, 0.9726, 0.9765, 0.9801, 
    0.9834, 0.9864, 0.9891, 0.9915, 0.9936, 0.9954, 0.9969, 0.9981, 0.9991, 0.9997, 1.0000, 1.0000, 0.9997, 0.9991, 0.9981, 
    0.9969, 0.9954, 0.9936, 0.9915, 0.9891, 0.9864, 0.9834, 0.9801, 0.9765, 0.9726, 0.9684, 0.9640, 0.9592, 0.9542, 0.9489, 
    0.9434, 0.9376, 0.9315, 0.9251, 0.9185, 0.9116, 0.9045, 0.8971, 0.8895, 0.8817, 0.8736, 0.8653, 0.8568, 0.8481, 0.8391, 
    0.8300, 0.8206, 0.8111, 0.8013, 0.7914, 0.7813, 0.7710, 0.7606, 0.7500, 0.7393, 0.7284, 0.7173, 0.7062, 0.6949, 0.6835, 
    0.6720, 0.6604, 0.6486, 0.6368, 0.6249, 0.6130, 0.6009, 0.5888, 0.5767, 0.5645, 0.5523, 0.5400, 0.5277, 0.5154, 0.5031, 
    0.4908, 0.4784, 0.4661, 0.4539, 0.4416, 0.4294, 0.4172, 0.4051, 0.3930, 0.3810, 0.3691, 0.3573, 0.3455, 0.3338, 0.3223, 
    0.3108, 0.2994, 0.2882, 0.2771, 0.2662, 0.2554, 0.2447, 0.2342, 0.2238, 0.2136, 0.2036, 0.1938, 0.1841, 0.1747, 0.1654, 
    0.1564, 0.1475, 0.1389, 0.1305, 0.1223, 0.1144, 0.1066, 0.0991, 0.0919, 0.0849, 0.0782, 0.0717, 0.0655, 0.0595, 0.0538, 
    0.0484, 0.0432, 0.0384, 0.0338, 0.0295, 0.0254, 0.0217, 0.0183, 0.0151, 0.0122, 0.0097, 0.0074, 0.0055, 0.0038, 0.0024, 
    0.0014, 0.0006, 0.0002, 0}; 
    
/* Blackman-Harris Window samples generated using MATLAB, can be used to apply  
   window function on collected samples */    
const float16_t Blackman_Harris_Window[FFT_SIZE] = {0.0001, 0.0001, 0.0001, 0.0001, 0.0002, 0.0003, 0.0004, 0.0005, 0.0007, 0.0008, 
    0.0010, 0.0013, 0.0016, 0.0019, 0.0022, 0.0026, 0.0031, 0.0036, 0.0042, 0.0048, 0.0055, 0.0063, 0.0072, 0.0081, 0.0092, 
    0.0104, 0.0116, 0.0130, 0.0145, 0.0162, 0.0180, 0.0199, 0.0220, 0.0243, 0.0267, 0.0293, 0.0321, 0.0351, 0.0384, 0.0418, 
    0.0454, 0.0493, 0.0535, 0.0579, 0.0625, 0.0674, 0.0726, 0.0781, 0.0839, 0.0900, 0.0963, 0.1030, 0.1100, 0.1173, 0.1250, 
    0.1330, 0.1413, 0.1500, 0.1590, 0.1683, 0.1780, 0.1881, 0.1985, 0.2092, 0.2203, 0.2317, 0.2435, 0.2556, 0.2680, 0.2807, 
    0.2938, 0.3072, 0.3209, 0.3348, 0.3491, 0.3636, 0.3784, 0.3934, 0.4087, 0.4242, 0.4398, 0.4557, 0.4717, 0.4879, 0.5042, 
    0.5206, 0.5371, 0.5536, 0.5702, 0.5868, 0.6035, 0.6200, 0.6366, 0.6531, 0.6694, 0.6857, 0.7018, 0.7177, 0.7334, 0.7489, 
    0.7642, 0.7792, 0.7938, 0.8082, 0.8222, 0.8358, 0.8490, 0.8618, 0.8742, 0.8861, 0.8975, 0.9083, 0.9187, 0.9285, 0.9378, 
    0.9464, 0.9545, 0.9619, 0.9687, 0.9749, 0.9804, 0.9852, 0.9894, 0.9929, 0.9957, 0.9978, 0.9992, 0.9999, 0.9999, 0.9992, 
    0.9978, 0.9957, 0.9929, 0.9894, 0.9852, 0.9804, 0.9749, 0.9687, 0.9619, 0.9545, 0.9464, 0.9378, 0.9285, 0.9187, 0.9083, 
    0.8975, 0.8861, 0.8742, 0.8618, 0.8490, 0.8358, 0.8222, 0.8082, 0.7938, 0.7792, 0.7642, 0.7489, 0.7334, 0.7177, 0.7018, 
    0.6857, 0.6694, 0.6531, 0.6366, 0.6200, 0.6035, 0.5868, 0.5702, 0.5536, 0.5371, 0.5206, 0.5042, 0.4879, 0.4717, 0.4557, 
    0.4398, 0.4242, 0.4087, 0.3934, 0.3784, 0.3636, 0.3491, 0.3348, 0.3209, 0.3072, 0.2938, 0.2807, 0.2680, 0.2556, 0.2435, 
    0.2317, 0.2203, 0.2092, 0.1985, 0.1881, 0.1780, 0.1683, 0.1590, 0.1500, 0.1413, 0.1330, 0.1250, 0.1173, 0.1100, 0.1030, 
    0.0963, 0.0900, 0.0839, 0.0781, 0.0726, 0.0674, 0.0625, 0.0579, 0.0535, 0.0493, 0.0454, 0.0418, 0.0384, 0.0351, 0.0321, 
    0.0293, 0.0267, 0.0243, 0.0220, 0.0199, 0.0180, 0.0162, 0.0145, 0.0130, 0.0116, 0.0104, 0.0092, 0.0081, 0.0072, 0.0063, 
    0.0055, 0.0048, 0.0042, 0.0036, 0.0031, 0.0026, 0.0022, 0.0019, 0.0016, 0.0013, 0.0010, 0.0008, 0.0007, 0.0005, 0.0004, 
    0.0003, 0.0002, 0.0001, 0.0001, 0.0001, 0.0001}; 

/******************************************************************************
 * Function definitions
 ******************************************************************************/

/**-----------------------------------------------------------------------------
 * @brief       Calculate column length for choosen frequencies.
 * @param[in]   Buffer number (0 or 1)
 * @descritpion Frequencies on given columns are respectively:
 * 
 * For Mode 1:
 *  [1] [2] [3] [4] [5] [6]  [7]  [8]  [9] [10] [11] [12] [13] [14]  [15]  [16] 
 * |156|312|469|625|781|938|1094|1250|1407|2500|3750|5000|7031|9062|12031|14844|
 *   
 * For Mode 2-8:
 * ((Mode-2)*16+N+1)*156, where N is integer in range 0-15  
 */
void FFT_CalculateColumns_256(uint8_t bufferNumber) {
    
    if( FFTstatus.mode == 1 ) {
        for( uint8_t i=1; i<10; i++ ) {
            FrequencyBins[i-1] = (uint8_t)(log10(FFT_Buffer[bufferNumber][i])
                                  *16/FFT_AVG_MAX_VALUE);
        }
    
        FrequencyBins[9]  = (uint8_t)(log10(FFT_Buffer[bufferNumber][16])
                             *16/FFT_AVG_MAX_VALUE);
        FrequencyBins[10] = (uint8_t)(log10(FFT_Buffer[bufferNumber][24])
                             *16/FFT_AVG_MAX_VALUE);
        FrequencyBins[11] = (uint8_t)(log10(FFT_Buffer[bufferNumber][32])
                             *16/FFT_AVG_MAX_VALUE);
        FrequencyBins[12] = (uint8_t)(log10(FFT_Buffer[bufferNumber][45])
                             *16/FFT_AVG_MAX_VALUE);
        FrequencyBins[13] = (uint8_t)(log10(FFT_Buffer[bufferNumber][58])
                             *16/FFT_AVG_MAX_VALUE);
        FrequencyBins[14] = (uint8_t)(log10(FFT_Buffer[bufferNumber][77])
                             *16/FFT_AVG_MAX_VALUE);
        FrequencyBins[15] = (uint8_t)(log10(FFT_Buffer[bufferNumber][95])
                             *16/FFT_AVG_MAX_VALUE);
    }
    else {
        for( uint8_t i=0; i<16; i++ ) {
            FrequencyBins[i] = (uint8_t)(log10(FFT_Buffer[bufferNumber]
                               [(FFTstatus.mode-2)*16+i+1])*16/FFT_AVG_MAX_VALUE);
        }
    }
}

/**-----------------------------------------------------------------------------
 * @brief Print frequency bin columns on LCD
 */
void FFT_PrintColumns(void) {
    for( uint8_t i=0; i<16; i++ ) {
        FrequencyBins[i] = FrequencyBins[i] >= 10 ? FrequencyBins[i] -= 9 : 0;
        /* check if value needs to be printed "again" */
        if( oldBins[i] != FrequencyBins[i] ) {
            LCD1602_PrintLVL_16_FFT(FrequencyBins[i], oldBins[i], i);
            oldBins[i] = FrequencyBins[i];
        }
    }
}